<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring.app.js.notice.model.NoticeDAO">

    <select id="selectTopNotices" parameterType="Long" resultType="NoticeDTO">
        SELECT 
            notice_id AS noticeId,
            admin_no AS adminNo,
            fk_hotel_id AS fkHotelId,
            title,
            content,
            is_top AS isTop,
            created_at AS createdAt
        FROM NOTICES
        WHERE is_top = 'Y'
        <if test="hotelId != null and hotelId != 0">
            AND fk_hotel_id = #{hotelId}
        </if>
        ORDER BY created_at DESC
    </select>

    <select id="selectNoticeListWithSearch" resultType="NoticeDTO" parameterType="HashMap">
        SELECT *
        FROM (
            SELECT 
                ROW_NUMBER() OVER(ORDER BY created_at DESC) AS RNUM,
                notice_id AS noticeId, 
                admin_no AS adminNo, 
                fk_hotel_id AS fkHotelId, 
                title, 
                content, 
                is_top AS isTop, 
                created_at AS createdAt
            FROM notices
            WHERE is_top = 'N'
            <if test="hotelId != null and hotelId != 0">
                AND fk_hotel_id = #{hotelId}
            </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND title LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="searchType == 'content'">
                        AND content LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="searchType == 'all'">
                        AND (title LIKE '%' || #{keyword} || '%' OR content LIKE '%' || #{keyword} || '%')
                    </when>
                </choose>
            </if>
        ) V
        WHERE RNUM BETWEEN #{startRow} AND #{endRow}
    </select>

    <select id="getTotalCount" parameterType="HashMap" resultType="int">
        SELECT count(*)
        FROM notices
        WHERE is_top = 'N'
        <if test="hotelId != null and hotelId != 0">
            AND fk_hotel_id = #{hotelId}
        </if>
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND title LIKE '%' || #{keyword} || '%'
                </when>
                <when test="searchType == 'content'">
                    AND content LIKE '%' || #{keyword} || '%'
                </when>
                <when test="searchType == 'all'">
                    AND (title LIKE '%' || #{keyword} || '%' OR content LIKE '%' || #{keyword} || '%')
                </when>
            </choose>
        </if>
    </select>

    <select id="selectNoticeDetail" resultType="NoticeDTO">
        SELECT 
            notice_id AS noticeId, 
            admin_no AS adminNo, 
            fk_hotel_id AS fkHotelId, 
            title, 
            content,
            is_top AS isTop, 
            created_at AS createdAt
        FROM NOTICES 
        WHERE notice_id = #{noticeId}
    </select>

    <insert id="insertNotice">
        INSERT INTO NOTICES (
            notice_id, admin_no, fk_hotel_id, title, content, is_top
        ) VALUES (
            SEQ_NOTICE_ID.NEXTVAL, #{adminNo}, #{fkHotelId}, #{title}, #{content}, #{isTop}
        )
    </insert>

    <update id="updateNotice">
        UPDATE NOTICES SET
            title = #{title},
            content = #{content},
            is_top = #{isTop},
            fk_hotel_id = #{fkHotelId}
        WHERE notice_id = #{noticeId}
    </update>

    <delete id="deleteNotice">
        DELETE FROM NOTICES WHERE notice_id = #{noticeId}
    </delete>

    <select id="selectNoticeList" parameterType="Long" resultType="NoticeDTO">
        SELECT 
            notice_id AS noticeId,
            admin_no AS adminNo,
            fk_hotel_id AS fkHotelId,
            title,
            content,
            is_top AS isTop,
            created_at AS createdAt
        FROM NOTICES
        <where>
            <if test="hotelId != null and hotelId != 0">
                fk_hotel_id = #{hotelId}
            </if>
        </where>
        ORDER BY is_top DESC, created_at DESC
    </select>

</mapper>
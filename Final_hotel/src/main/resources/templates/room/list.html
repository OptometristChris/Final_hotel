<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>객실 목록</title>

<style>
body { font-family: Arial; }

.room-card {
    border-bottom: 1px solid #ddd;
    padding: 30px 0;
    display: flex;
    gap: 30px;
}

.room-image {
    width: 300px;
    height: 200px;
    background-color: #eee;
}

.room-info {
    flex: 1;
}

.room-name {
    font-size: 22px;
    font-weight: bold;
}

.price {
    font-size: 20px;
    font-weight: bold;
    margin-top: 15px;
}
</style>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">

</head>
<body>

<h1>객실</h1>

<!-- ===============================
      필터 (AJAX)
     =============================== -->
<form id="filterForm">

    객실등급:
    <select name="room_grade">
        <option value="">전체</option>
        <option value="DELUXE">DELUXE</option>
        <option value="PREMIER">PREMIER</option>
        <option value="SUITE">SUITE</option>
        <option value="STANDARD">STANDARD</option>
    </select>

    침대타입:
    <select name="bed_type">
        <option value="">전체</option>
        <option value="DOUBLE">DOUBLE</option>
        <option value="TWIN">TWIN</option>
        <option value="KING">KING</option>
    </select>

    전망:
    <select name="view_type">
        <option value="">전체</option>
        <option value="CITY">CITY</option>
        <option value="RIVER">RIVER</option>
    </select>

    <button type="submit">검색</button>
</form>

<hr>

<!-- ===============================
     객실 목록 영역
     =============================== -->
<div id="roomListArea">

    <div th:each="room : ${roomList}" class="room-card">

        <div class="room-image">
            <img th:src="@{${room.image_url}}"
                 style="width:100%; height:100%; object-fit:cover;">
        </div>

        <div class="room-info">
            <div class="room-name">
                <a th:href="@{/room/detail(room_id=${room.room_type_id})}"
                   th:text="${room.room_name}"
                   style="text-decoration:none; color:black;"></a>
            </div>

            <div>등급: <span th:text="${room.room_grade}"></span></div>
            <div>침대: <span th:text="${room.bed_type}"></span></div>
            <div>전망: <span th:text="${room.view_type}"></span></div>

            <div class="price">
                ₩ <span th:text="${room.base_price}"></span>
            </div>
            
            <div style="margin-top:20px;">
			    <button th:onclick="'openCalendar(' + ${room.room_type_id} + ')'">
				    예약하기
				</button>
			</div>
        </div>
    </div>	
</div>


<!-- =======================
	 예약 모달
	======================= -->
<div id="calendarModal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">

    <div style="background:white; width:900px; margin:80px auto; padding:30px; position:relative;">
        <button onclick="closeModal()" style="position:absolute; right:10px; top:10px;">X</button>

        <h2>날짜 선택</h2>

        <!-- 실제 달력 -->
        <div id="calendar"></div>
    </div>
</div>


<!-- ===============================
     AJAX 스크립트
     =============================== -->

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<script>

// ===============================
// 필터 AJAX
// ===============================
document.getElementById("filterForm").addEventListener("submit", function(e){
    e.preventDefault();

    const roomGrade = document.querySelector("[name='room_grade']").value;
    const bedType = document.querySelector("[name='bed_type']").value;
    const viewType = document.querySelector("[name='view_type']").value;

    fetch(`/final_hotel/room/filter?room_grade=${roomGrade}&bed_type=${bedType}&view_type=${viewType}`)
        .then(response => response.json())
        .then(data => {

            const area = document.getElementById("roomListArea");
            area.innerHTML = "";

            if(data.length === 0){
                area.innerHTML = "<p>검색 결과가 없습니다.</p>";
                return;
            }

            data.forEach(room => {
                area.innerHTML += `
                    <div class="room-card">
                        <div class="room-image">
                            <img src="/final_hotel${room.image_url}" 
                                 style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="room-info">
                            <div class="room-name">
                                <a href="/final_hotel/room/detail?room_id=${room.room_type_id}">
                                    ${room.room_name}
                                </a>
                            </div>
                            <div>등급: ${room.room_grade}</div>
                            <div>침대: ${room.bed_type}</div>
                            <div>전망: ${room.view_type}</div>
                            <div class="price">₩ ${room.base_price}</div>

                            <div style="margin-top:20px;">
                                <button onclick="openCalendar(${room.room_type_id})">
                                    예약하기
                                </button>
                            </div>

                        </div>
                    </div>
                `;
            });

        });
});


// ===============================
// 달력 모달
// ===============================
let calendarInstance = null;

function openCalendar(roomId) {

    document.getElementById("calendarModal").style.display = "block";

    fetch(`/final_hotel/room/calendar?room_id=${roomId}`)
        .then(res => res.json())
        .then(data => {

            const events = data.map(day => ({
                title: "₩ " + day.FINAL_PRICE,
                start: day.STAY_DATE,
                allDay: true
            }));

            const calendarEl = document.getElementById("calendar");

            if(calendarInstance !== null){
                calendarInstance.destroy();
            }

            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 650,
                events: events
            });

            calendarInstance.render();
        });
}

function closeModal(){
    document.getElementById("calendarModal").style.display = "none";
}

</script>

</body>
</html>